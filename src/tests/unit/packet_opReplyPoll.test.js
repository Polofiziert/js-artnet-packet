// These test should try to use the basic ArtNetPacket objects and test their functions
// It looks if vales are returned without errors and if they are as expected
// for futher infos https://nodejs.org/en/learn/test-runner/using-test-runner
// and https://nodejs.org/api/test.html#subtests

const assert = require('node:assert');
const test = require('node:test');

const { Buffer } = require('node:buffer');

const { ArtNetCodes } = require("../../codes")
const { PollReplyPacket } = require("../../packets/pollReplyPacket")

test('pollReplyPacket obj works corectly', (t) => {
    t.test('Object is createt and filled corectly | opCode 0x2100 [0]', () => {
        var packet = new PollReplyPacket
        assert.strictEqual(packet.data.id, "Art-Net"); // tests if the properties of the created obj populted corectly
        assert.strictEqual(packet.data.opCode, 0x2100);
    });

    t.test('encode() func works corectly', (t) => {
        var packet = new PollReplyPacket
        var bufExpected = new Uint8Array([0x41, 0x72, 0x74, 0x2d, 0x4e, 0x65, 0x74, 0x00, 0x00, 0x21, 0xc0, 0xa8, 0x02, 0x72, 0x36, 0x19, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x20, 0x6a, 0x65, 0x70, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x23, 0x30, 0x30, 0x30, 0x31, 0x20, 0x5b, 0x30, 0x30, 0x30, 0x31, 0x5d, 0x20, 0x7a, 0x7a, 0x7a, 0x7a, 0x7a, 0x2e, 0x2e, 0x2e, 0x54, 0x68, 0x69, 0x73, 0x20, 0x6e, 0x6f, 0x64, 0x65, 0x20, 0x46, 0x65, 0x65, 0x6c, 0x73, 0x20, 0x76, 0x65, 0x72, 0x79, 0x20, 0x67, 0x6f, 0x6f, 0x6f, 0x6f, 0x64, 0x21, 0x21, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x85, 0x85, 0x85, 0x85, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe6, 0x00, 0x8e, 0xe6, 0xd3, 0x74, 0xc0, 0xa8, 0x02, 0x72, 0x01, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])

        var bufActual = packet.encode()
        assert.deepStrictEqual(bufActual, bufExpected)
    });

    t.test('encode() func works corectly with changed data', (t) => {
        var packet = new PollReplyPacket
        packet.data.netSwitch = 2
        packet.data.status3.portDirectionSwitch = 'no'

        var bufExpected = new Uint8Array([0x41, 0x72, 0x74, 0x2d, 0x4e, 0x65, 0x74, 0x00, 0x00, 0x21, 0xc0, 0xa8, 0x02, 0x72, 0x36, 0x19, 0x00, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x20, 0x6a, 0x65, 0x70, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x23, 0x30, 0x30, 0x30, 0x31, 0x20, 0x5b, 0x30, 0x30, 0x30, 0x31, 0x5d, 0x20, 0x7a, 0x7a, 0x7a, 0x7a, 0x7a, 0x2e, 0x2e, 0x2e, 0x54, 0x68, 0x69, 0x73, 0x20, 0x6e, 0x6f, 0x64, 0x65, 0x20, 0x46, 0x65, 0x65, 0x6c, 0x73, 0x20, 0x76, 0x65, 0x72, 0x79, 0x20, 0x67, 0x6f, 0x6f, 0x6f, 0x6f, 0x64, 0x21, 0x21, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x85, 0x85, 0x85, 0x85, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe6, 0x00, 0x8e, 0xe6, 0xd3, 0x74, 0xc0, 0xa8, 0x02, 0x72, 0x01, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])

        var bufActual = packet.encode()
        assert.deepStrictEqual(bufActual, bufExpected)
    });

    t.test('decode() func works corectly backAndForth', (t) => {
        let packetExp = new PollReplyPacket()
        let packetAct = new PollReplyPacket()
        //let buf = new Uint8Array([0x41, 0x72, 0x74, 0x2d, 0x4e, 0x65, 0x74, 0x00, 0x00, 0x20, 0x04, 0x30, 0x1c, 0xf0, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01])
        let bufExp = packetExp.encode()
        packetAct.encode() // To get the Counter Up

        let packetActData = packetAct.decode(bufExp)
        assert.deepStrictEqual(packetActData, packetExp.data)
        assert.deepStrictEqual(packetAct, packetExp)
    });

    t.test('decode() func works corectly back', (t) => {
        let packetExp = new PollReplyPacket()
        let packetAct = new PollReplyPacket()
        let buf = new Uint8Array([0x41, 0x72, 0x74, 0x2d, 0x4e, 0x65, 0x74, 0x00, 0x00, 0x21, 0xc0, 0xa8, 0x02, 0x72, 0x36, 0x19, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x00, 0x6a, 0x73, 0x2d, 0x61, 0x72, 0x74, 0x6e, 0x65, 0x74, 0x2d, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x20, 0x6a, 0x65, 0x70, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x23, 0x30, 0x30, 0x30, 0x31, 0x20, 0x5b, 0x30, 0x30, 0x30, 0x31, 0x5d, 0x20, 0x7a, 0x7a, 0x7a, 0x7a, 0x7a, 0x2e, 0x2e, 0x2e, 0x54, 0x68, 0x69, 0x73, 0x20, 0x6e, 0x6f, 0x64, 0x65, 0x20, 0x46, 0x65, 0x65, 0x6c, 0x73, 0x20, 0x76, 0x65, 0x72, 0x79, 0x20, 0x67, 0x6f, 0x6f, 0x6f, 0x6f, 0x64, 0x21, 0x21, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x85, 0x85, 0x85, 0x85, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe6, 0x00, 0x8e, 0xe6, 0xd3, 0x74, 0xc0, 0xa8, 0x02, 0x72, 0x01, 0x7e, 0x60, 0x60, 0x60, 0x60, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])
        //let buf = packetExp.encode()

        let packetActData = packetAct.decode(buf)
        assert.deepStrictEqual(packetActData, packetExp.data)
        assert.deepStrictEqual(packetAct, packetExp)
    });

    t.test('_counterUp() func works corectly on rollover', (t) => {
        let packetExp = new PollReplyPacket()
        let packetAct = new PollReplyPacket()
        //let buf = new Uint8Array([0x41, 0x72, 0x74, 0x2d, 0x4e, 0x65, 0x74, 0x00, 0x00, 0x20, 0x04, 0x30, 0x1c, 0xf0, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01])
        let bufExp = packetExp.encode()
        packetAct.encode() // To get the Counter Up

        bufExp = packetExp.encode()
        packetAct.encode() // To get the Counter Up

        let packetActData = packetAct.decode(bufExp)
        assert.deepStrictEqual(packetActData, packetExp.data)
        assert.deepStrictEqual(packetAct, packetExp)
        
        for(var i=0; i < 10003; i++){
            bufExp = packetExp.encode()
            packetAct.encode() // To get the Counter Up
        }

        packetActData = packetAct.decode(bufExp)
        assert.deepStrictEqual(packetActData, packetExp.data)
        assert.deepStrictEqual(packetAct, packetExp)        
        assert.deepStrictEqual(packetExp.counters.nodeReport.value, 5)        
        assert.deepStrictEqual(packetAct.counters.nodeReport.value, 5)        
    });

});
