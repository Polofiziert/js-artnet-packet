// These test should try to use the basic ArtNetPacket objects and test their functions
// It looks if vales are returned without errors and if they are as expected
// for futher infos https://nodejs.org/en/learn/test-runner/using-test-runner
// and https://nodejs.org/api/test.html#subtests

const assert = require('node:assert');
const test = require('node:test');

const { Buffer } = require('node:buffer');
const util = require('util');
const dgram = require('node:dgram')


const { jap } = require("../../jap")

test('artnetProtocol Object works Correctly', (t) => {

    t.test('with own Socket', (t) => {

        t.test('create', (t) => {
            let justArtnet = new jap
            // this should work with no problem
            let artnetProtocol = justArtnet.createArtNetProtocol({
                host: "127.0.0.1", 
                port: 6454,
            })
        });

        t.test('bind and close', (t) => {
            let justArtnet = new jap
            // this should work with no problem
            let artnetProtocol = justArtnet.createArtNetProtocol({
                host: "127.0.0.1", 
                port: 6454,
            })

            artnetProtocol.bind()
            artnetProtocol.on('listening', ()=>{
                artnetProtocol.close();
            });
        });

        t.test('bind and close', (t) => {
            let justArtnet = new jap
            // this should work with no problem
            let artnetProtocol = justArtnet.createArtNetProtocol({
                host: "127.0.0.1", 
                port: 6454,
            })

            artnetProtocol.bind()
            artnetProtocol.on('listening', ()=>{
                artnetProtocol.close();
            });
        });

    });

    t.test('with given Socket', (t) => {

        t.test('create', (t) => {
            let socket = dgram.createSocket('udp4')
            let justArtnet = new jap

            // this should work with no problem
            let artnetProtocol = justArtnet.createArtNetProtocol({socket})
        });

        t.test('bind and close', (t) => {
            let socket = dgram.createSocket('udp4')
            let justArtnet = new jap

            let options = {
                address: 'localhost',
                port: 6454,
            } 

            let artnetProtocol = justArtnet.createArtNetProtocol({socket})

            socket.on('listening', ()=>{
                // console.log("socket listening")
                artnetProtocol.bind()
            });
            socket.on('close', ()=>{
                // console.log("socket close")
            });
            artnetProtocol.on('listening', ()=>{
                // console.log("protocol listening")
                artnetProtocol.close();
            });
            artnetProtocol.on('close', ()=>{
                // console.log("protocol close")
                socket.close();
            });
            
            socket.bind(options)
        });

        t.test('inspect unbound protocolObj and bound socketObj', (t) => {
            let socket = dgram.createSocket('udp4')
            let justArtnet = new jap

            let options = {
                address: 'localhost',
                port: 6454,
            } 

            let artnetProtocol = justArtnet.createArtNetProtocol({socket})

            t.before( (t)=> {
                console.log("unbound protocolObj: opening socket")
                socket.bind(options)
            })

            t.test('unbound protocolObj: socketObj has no Listeners', (t) => {
                t.test('no close Listener', (t) => {
                        let actualCloseListener = util.inspect(socket.listeners('close'))
                        let expectetCloseListener = "[]"
                        
                        // Socket should have no Listeners
                        assert.deepEqual(actualCloseListener, expectetCloseListener)
                });
                t.test('no message Listener', (t) => {
                        let actualMsgListener = util.inspect(socket.listeners('message'))
                        let expectetMsgListener = "[]"                        
                                            
                        // Socket should have no Listeners
                        assert.deepEqual(actualMsgListener, expectetMsgListener)
                });

                t.test('no error Listener', (t) => {
                        let actualErrorListener = util.inspect(socket.listeners('error'))
                        let expectetErrorListener = "[]"
                        
                        // Socket should have no Listeners
                        assert.deepEqual(actualErrorListener, expectetErrorListener)
                });

                t.test('no listening Listener', (t) => {
                        let actualListeningListener = util.inspect(socket.listeners('listening'))
                        let expectetListeningListener = "[]"
                        
                        // Socket should have no Listeners
                        assert.deepEqual(actualListeningListener, expectetListeningListener)
                });
            });

            t.test('unbound protocolObj: protocolObj is...', (t) => {
                t.test('no receiving', (t) => {
                        let actual = artnetProtocol.receiving;
                        let expected = 0;

                        // Socket should have no Listeners
                        assert.deepEqual(actual, expected)
                });
                t.test('no ownsSocket', (t) => {
                        let actual = artnetProtocol.ownsSocket;
                        let expected = 0;

                        // Socket should have no Listeners
                        assert.deepEqual(actual, expected)
                });
                t.test('no host', (t) => {
                        let actual = artnetProtocol.host;
                        let expected = null;

                        // Socket should have no Listeners
                        assert.deepEqual(actual, expected)
                });
                t.test('no port', (t) => {
                        let actual = artnetProtocol.port;
                        let expected = null;

                        // Socket should have no Listeners
                        assert.deepEqual(actual, expected)
                });
            });

            t.after( (t) => {
                console.log("unbound protocolObj: closing socket")
                socket.close()
            })
        });

        test('inspect bound protocolObj and bound socketObj', (t) => {
            let socket = dgram.createSocket('udp4')
            let justArtnet = new jap

            let options = {
                address: 'localhost',
                port: 80,
            } 

            let artnetProtocol = justArtnet.createArtNetProtocol({socket})

            await t.test("test", (t) => {
                
            })

            
        });

    });

});